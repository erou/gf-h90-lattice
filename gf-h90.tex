\documentclass{sig-alternate}

\usepackage{hyperref}
\usepackage{macros}

\newtheorem{theorem}{Theorem}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{definition}[theorem]{Definition}

\numberofauthors{3}
\author{
  \alignauthor Luca De Feo\\
  \affaddr{Universit\'e Paris Saclay -- UVSQ, LMV}\\
  \email{luca.de-feo@uvsq.fr}
  \alignauthor Hugues Randriam
  \alignauthor \'Edouard Rousseau
}

\title{Efficient lattices of compatibly embedded finite fields}

\begin{document}

\maketitle

\begin{abstract}
  Lattices of compatibly embedded finite fields are useful in computer
  algebra systems for managing many extensions of a finite field
  $\F_p$ at once. %
  They can also be used to represent the algebraic closure $\bar\F_p$,
  and to represent all finite fields in a standard manner.

  The most well known constructions are Conway polynomials, and the
  Bosma-Cannon-Steel framework used in Magma. %
  They all have drawbacks: Conway polynomials are extremely expensive
  to compute, while the Bosma-Cannon-Steel framework does not provide
  a standard way to represent finite fields, and becomes inefficient
  as the number of extensions grows.

  In this work, leveraging the theory of the Lenstra-Allombert
  isomorphism algorithm, we generalize at the same time Conway
  polynomials and the Bosma-Cannon-Steel framework, obtaining the
  first construction with quadratic complexity in the extension
  degree, and linear complexity in the number of extensions. %
  We also provide an implementation in C/Flint/Julia/Nemo, showing
  that our construction is practical.
\end{abstract}

\category{F.2.1}{Theory of computation}{Analysis of algorithms and problem complexity}[Computations in finite fields]
\category{G.4}{Mathematics of computing}{Mathematical software}
\terms{Algorithms,Theory}
\keywords{Finite fields, field extensions, Conway polynomials.}

\section{Introduction}
\label{sec:introduction}

Computer algebra systems (CAS) are often faced with the problem of
constructing several extensions of a finite field $\F_p$ in a
\emph{compatible} way, i.e., such that the (subfield) inclusion
lattice of the given extensions can be computed and evaluated
efficiently.

Concretely, what is sought is a data structure $\Lambda$ to represent
arbitrary collections of extensions of $\F_{p}$, in such a way that
elements of $\F_{p^n}$ are represented in optimal space (i.e., $O(n)$
coefficients), and that arithmetic operations are performed
efficiently (i.e., $O\left(\lcm(n,m)^d\right)$ arithmetic operations
to combine an element of $\F_{p^m}$ and an element of $\F_{p^n}$,
where $d\le 3$ and, possibly, $d=1+\varepsilon$). %
To this end, it is useful to set several sub-goals:

\begin{description}
\item[\emph{Effective embeddings:}] For any pair of extensions
  $k\subset K$ in $\Lambda$, there exists an efficiently computable
  embedding $\phi:k\to K$, and algorithms to evaluate $\phi$ on $k$,
  and the section $\phi^{-1}$ on $K$.
\item[\emph{Compatibility:}] The embeddings are \emph{compatible},
  i.e., for any triple $k\subset K\subset L$ in $\Lambda$, and
  embeddings $\phi:k\to K$, $\psi:K\to L$, $\chi:k\to L$, one has
  $\chi=\psi\circ\phi$.
\item[\emph{Incrementality:}] The data associated with an extension
  (e.g., its irreducible polynomial, change-of-basis matrices, \dots)
  must be computable efficiently and \emph{incrementally}, i.e.,
  adding a new field extension to $\Lambda$ does not require
  recomputing data for all extensions already in $\Lambda$. %
\item[\emph{Uniqueness:}] Any extension of $\F_{p}$ is determined by an
  irreducible polynomial whose definition only depends on the
  characteristic $p$ and the degree of the extension. %
\item[\emph{Generality:}] Extensions of $\F_{p}$ can be represented by
  arbitrary irreducible polynomials.
\end{description}

Some goals, such as incrementality, uniqueness and generality are
optional, and it is obvious that uniqueness and generality are even in
conflict with each other. %
An incremental data structure can be used to effectively represent an
algebraic closure $\bar\F_{p}$, with new finite extensions built on the
fly as they are needed. %
Uniqueness is useful for defining field elements in a standard way,
portable between different CAS, while generality is useful in a
context where the user is left with the freedom of choosing the
defining polynomials. %
Note that any solution can be made unique by replacing all random
choices with pseudo-random ones, however one is usually interested in
uniqueness solutions that have a simple mathematical description. %
Also, any solution can be made general by means of an isomorphism
algorithm~\cite{LenstraJr91,Allombert02,rains2008,brieulle2018computing,narayanan2016fast}. %
Other optional goals, such as computing normal bases or evaluating
Frobenius morphisms, may be added to the list, however they are out of
the scope of this work.

\paragraph{Previous work}
The first and most well known solution is the family of Conway
polynomials~\cite{Nickel1988,heath+loehr99}, first adopted in
GAP~\cite{GAP4}, and then also by Magma~\cite{MAGMA} and
Sage~\cite{Sage}. %
Conway polynomials yield uniqueness, however computing them requires
exponential time, thus incrementality is only available at a
prohibitive cost; for this reason, they are usually pre-computed and
tabulated up to some bound.

The first to show the existence of a (incremental, general) data
structure computable in deterministic polynomial time was
Lenstra~\cite{LenstraJr91}, who proved that, besides the problem of
finding irreducible polynomials, any other question is amenable to
linear algebra. %
Subsequent work of Lenstra and de
Smit~\cite{lenstra+desmit08-stdmodels} tackled the uniqueness problem,
albeit only from a theoretical point of view. %

In practice, randomized algorithms are good enough for a CAS, then
polynomial factorization and basic linear algebra provide an easy
(incremental, general) solution, that was first analyzed by Bosma,
Cannon and Steel~\cite{bosma+cannon+steel97}, and is currently used in
Magma. %

All solutions presented so far have superquadratic complexity, i.e.,
$d>2$. %
Recent work on embedding algorithms~\cite{DoSc12,DeDoSc13,DeDoSc2014}
yields subquadratic (more precisely, $d\le 1.5$) solutions for
specially constructed (non-unique, non-general) families of
irreducible polynomials, and even quasi-optimal ones (i.e.,
$d=1+\varepsilon$) if a quasi-linear modular composition algorithm is
available (Kedlaya and Umans' algorithm~\cite{KeUm11} is quasi-optimal
in the binary RAM model, however it is widely considered
unpractical). %
However these constructions involve counting points of random elliptic
curves over finite fields, and have thus a rather high polynomial
dependency in $\log p$; for this reason, they are usually considered
practical only for relatively small characteristic.


\paragraph{Our contribution}
In this work we present the first
quadratic, % TODO: let's hope this is true...
incremental, general and/or unique % TODO: also this...
solution for lattices of compatibly embedded finite fields. %
Our starting point is Allombert's~\cite{Allombert02} and
subsequent~\cite{brieulle2018computing} improvements to Lenstra's
isomorphism algorithm. %
Plugging them in the Bosma-Cannon-Steel framework immediately produces
a quadratic, incremental general solution, however we go much
further. %
Indeed, we show that the compatibility requirement can be taken a step
further by constructing a lattice of $\F_{p}$-algebras with a
distinguished element, which is a byproduct of the Lenstra-Allombert
algorithm.

The advantages of our construction over a naive combination of the
Lenstra-Allombert algorithm and the Bosma-Cannon-Steel framework are
multiple. %
Storage drops from quadratic to linear in the number of extensions
stored in $\Lambda$, and the cost of adding a new extension to
$\Lambda$ drops similarly. %
This yields a significant speedup in practice, as we show in our
implementation (see Section~\ref{sec:implementation}).

Our $\F_{p}$-algebras are constructed by tensoring element-wise an
arbitrary lattice of extensions of $\F_{p}$ with a lattice of compatible
roots of unity. %
One of the possible ways to construct the second lattice is by using
Conway polynomials; this way, our construction can be seen as a
generalization of Conway polynomials, permitting to represent
(uniquely) an exponentially larger set of finite fields than with
Conway polynomials alone. %
Since the storage overhead for the second lattice is only logarithmic
in the degree of the extension fields, the high cost for computing
Conway polynomials is absorbed in the total complexity.

The main drawback of our method is that, in some instances, combining
elements of $\F_{p^m}$ and $\F_{p^n}$ requires constructing a field
extension of degree larger than $\lcm(m,n)$. %
While this does not affect the asymptotic complexity of our
construction, % TODO: doesn't it?
it can in practice make some computations visibly slower.


\paragraph{Organisation}
The presentation is structured as follows. %
In Section~\ref{sec:conway} we review some basic facts on roots of
unity and Conway polynomials. %
In Section~\ref{sec:lenstra} we review the Lenstra-Allombert algorithm
and we define and study \emph{Kummer algebras},
the main ingredient to our construction. %
In Section~\ref{sec:compatibleH90} we introduce a notion of compatibility
for solutions of Hilbert~90 in Kummer algebras, that provides standard
defining polynomials for finite fields.
Then in Section~\ref{sec:construction} we use these compatible solutions
to incrementally construct lattices with compatible embeddings.
Finally, in Section~\ref{sec:implementation} we present our
implementation and compare it to available alternatives.


\section{Compatible roots of unity and Conway polynomials}
\label{sec:conway}

% TODO: copy-pasted from Luca's HDR without editing. Clean and shorten
% this.

One of the most famous constructions is that of \emph{Conway
  polynomials}. %
The main feature of Conway polynomials is \emph{norm compatibility}:
the norm map $\F_{q^n}\to\F_{q^m}$ is a surjection from the roots of the
$n$-th Conway polynomial to the roots of the $m$-th Conway polynomial,
whenever $m$ divides $n$. %

Norm compatibility is easy to achieve for a fixed collection
$\mathcal{F}$ of finite extensions of $\F_{p}$: let $K/\F_{p}$ be the
smallest finite field containing all fields in $\mathcal{F}$, let
$\eta$ be a primitive element of $K$, i.e., a generator of the
multiplicative group $K^\times$, then the Conway polynomial of a field
$k\subset K$ is defined as the minimal polynomial of $N_{K/k}(\eta)$,
where $N_{K/k}$ is the norm map. %
However, Conway polynomials have two other goals: incrementality and
uniqueness. %
This leads to the following definition.

\begin{definition}[Conway polynomial]
  Let $p$ be a prime and $n>1$ an integer. %
  The \emph{Conway polynomial} $C_{p,n}$ is the
  \emph{lexicographically smallest} monic irreducible polynomial of
  degree $n$ satisfying the following conditions:
  \begin{itemize}
  \item \emph{Primitivity:} $C_{p,n}$ is primitive (i.e., its roots
    generate the multiplicative group $\F_{p^n}^\times$);
  \item \emph{Norm compatibility:} If $m$ divides $n$, then
    $C_{p,m}\left(X^{\frac{p^n-1}{p^m-1}}\right) = 0 \mod C_{p,n}$.
  \end{itemize}
\end{definition}

The ``lexicographically smallest'' condition is required to ensure
uniqueness; it is typically defined by writing $f\in\F_{p}[X]$ as
\begin{equation*}
  f = \sum_{i=0}^n (-1)^{n-i} f_i x^i,
  \qquad\text{with $0\le f_i<p$,}
\end{equation*}
and taking the lexicographic order on the words $f_n\dots f_0$.

Conway polynomials were defined by Parker%
\footnote{According to Lübeck~\cite{Luebeck}.}, %
who named them in honor of John Conway and his famous book ``On
Numbers and Games''~\cite{Conway:ONAG2000}; their existence was shown
by Nickel~\cite{Nickel1988}. %
They were first adopted by the computer algebra system GAP~\cite{GAP4}
as a default representation for finite fields. %
They are typically computed by exhaustive search over all irreducible
polynomials, or by a slightly better algorithm due to Heath and
Loehr~\cite{heath+loehr99}. %
Given the huge computational cost involved in finding them, they are
usually precomputed; tables of Conway polynomials are available in any
major computer algebra system.%
\footnote{Most computer algebra systems switch to other methods when
  precomputed Conway polynomials are not available. %
  An interesting exception is SageMath (since version
  5.13~\cite{Roe2013}), that defines \emph{pseudo-Conway polynomials}
  by dropping the ``lexicographically first'' requirement, and
  computes them on the fly whenever a true Conway polynomial is not
  available in the tables. %
  The approach is notoriously slow: computing a pseudo-Conway
  polynomial for $\F_{p^{30}}$ takes in the order of seconds, already
  for $p>1000$; compare this to the milliseconds needed to compute a
  random irreducible polynomial of the same degree.} %

We note that Conway polynomials are not especially good to represent
embeddings: given an element of $\F_{p^m}$ represented as
$a(X) \bmod C_{p,m}(X)$, its image in $\F_{p^n}$, for $m\mid n$, is
computed as $a(X^{(p^n-1)/(p^m-1)})\bmod C_{p,n}(X)$, requiring very
large modular exponentiations; while there are algorithms to perform
this computation in $O(n^{1+o(1)})$ operations~\cite{KeUm11}, they are
known to be very inefficient in practice. %


\section{The Lenstra-Allombert embedding algorithm}
\label{sec:lenstra}
\cite{LenstraJr91}\cite{brieulle2018computing}

%TODO: add context? Change the notation to get rid of \Phi and \phi ?

The main ingredient of Allombert's algorithm~\cite{Allombert02} is an extension
of Kummer theory.
On any finite extension of $\F_{p}$, denote by \[ \sigma:x\mapsto x^p \]
the Frobenius automorphism.
Let $\ell$ be an integer not divisible by $p$.
Then $\sigma$ acting on $\F_{p^\ell}$ can be seen as a $\F_{p}$-linear endomorphism,
with minimal polynomial $T^\ell-1$, which is separable but not necessarily split,
i.e. $\F_{p^\ell}$ is not necessarily a Kummer extension of $\F_{p}$.
We make an extension of scalars and work in the
\emph{Kummer algebra of degree $\ell$}:
\[
  A_\ell = \F_{p^\ell}\otimes\F_{p}(\zeta_\ell),
\]
where $\otimes$ is tensor product over $\F_{p}$, and $\zeta_\ell$ is a primitive $\ell$-th root of unity. We
call $\F_{p}(\zeta_\ell)$ the \emph{field of scalars} of $A_\ell$, and
we define the \emph{level} of $A_\ell$ as
\[
  \lambda(\ell) = \omega_{(\mathbb{Z}/\ell\mathbb{Z})^\times}(p) = [\F_{p}(\zeta_\ell):\F_{p}],
\]
that is, the degree of its field of scalars.

Now $\sigma\otimes1$ is a $1\otimes\F_{p}(\zeta_\ell)$-linear endomorphism of $A_\ell$
with $\ell$ distinct eigenvalues, namely the powers of $1\otimes\zeta_\ell$.
Thus, if $\eta=\zeta_\ell^i$ is any $\ell$-th root of unity in $\F_{p}(\zeta_\ell)$,
the corresponding eigenspace is defined by the \emph{Hilbert 90 equation for $\eta$}:
\begin{equation}
  \tag{H90}
 (\sigma\otimes1)(x) = (1\otimes\eta)x,
  \label{h90}
\end{equation}
which plays the role of $\sigma(x)=\eta x$ in classical Kummer theory.
The solutions of~\eqref{h90} in $A_\ell$ form a
$1\otimes\F_{p}(\zeta_{\ell})$-vector space of dimension $1$,
and if $x$ is such a solution for $\eta$, then $x^j$ is a solution for $\eta^j$.

In particular, let $\alpha_\ell$ be a nonzero solution of~\eqref{h90} for $\zeta_\ell$.
Then $1,\alpha_\ell,\cdots,(\alpha_\ell)^{\ell-1}$ are eigenvectors for distinct eigenvalues and thus
form a basis of $A_\ell$ over $1\otimes\F_{p}(\zeta_{\ell})$,
while
\[ (\alpha_\ell)^\ell = 1\otimes\a_\ell \]
for a certain scalar constant $\a_\ell=\a(\alpha_\ell)\in\F_{p}(\zeta_\ell)$.
This proves:
\begin{proposition}
\label{alphagen}
Any such $\alpha_\ell$ is a generating element for $A_\ell$ as an algebra over $1\otimes\F_{p}(\zeta_{\ell})$,
inducing an isomorphism
\[ A_\ell\simeq \F_{p}(\zeta_{\ell})[T]/(T^\ell-\a_\ell). \]
\end{proposition}

Since $A_\ell$ is known to be an \'etale algebra, we also note that this implies
that $\a_\ell$ is nonzero, which in turn implies
that $\alpha_\ell$ in \emph{invertible} in $A_\ell$: $\;(\alpha_\ell)^{-1} = (1\otimes\a_\ell^{-1})(\alpha_\ell)^{\ell-1}$.


We will make frequent use of the following:
\begin{lemma}
\label{FrobFrob}
Let $K,L$ are two finite extensions of $\F_{p}$.
Then for any $\beta\in K\otimes L$,
we have $(\sigma\otimes\sigma)(\beta)=\beta^p$.
\end{lemma}
In this generality we also introduce the following notation: if $\eta\in L$ has degree $d$ over $\F_{p}$,
then any $\beta\in K\otimes\F_{p}(\eta)\subset K\otimes L$ decomposes uniquely as $\beta = \sum_{i =  0}^{d-1}y_i\otimes\eta^i$,
and we set  \[ \first{\beta}{\eta}=y_0. \]
In particular, back to $A_\ell$, if we write
$\alpha_\ell = \sum_{i =  0}^{a-1}x_i\otimes\zeta_{\ell}^i$ where $a=\lambda(\ell)$,
it is shown in~\cite{Allombert02} that $x_0=\first{\alpha_\ell}{\zeta_\ell}$ is a generating element for the extension
$\F_{p^\ell}/\F_{p}$.

\begin{proposition}
\label{depend}
With the notations above, there are precisely $\ell$ elements $x\in A_\ell$ that are solutions of~\eqref{h90} for $\zeta_\ell$
and satisfy $x^\ell=1\otimes\a_\ell$, namely, these are the $(1\otimes\zeta_\ell)^u\alpha_\ell=(\sigma^u\otimes 1)(\alpha_\ell)$
for $0\leq u<\ell$.
The corresponding generating elements for $\F_{p^\ell}/\F_{p}$ are the $\first{(\sigma^u\otimes 1)(\alpha_\ell)}{\zeta_\ell}=\sigma^u(x_0)$.
They all have the same minimal polynomial, which is a generating polynomial for $\F_{p^\ell}/\F_{p}$ that depends only on $\a_\ell$.
\end{proposition}
\begin{proof}
Clear.
\end{proof}

Now we consider Kummer algebras of various degrees.
Using, for instance, Conway polynomials, we assume that the fields of scalars are compatibly embedded:
for $\ell\,|\,m$ not divisible by $p$, we have the embedding
\[
\begin{array}{cccc}
  \embedcyc{\ell}{m}: & \F_{p}(\zeta_\ell) & \hookrightarrow & \F_{p}(\zeta_m) \\
  & \zeta_\ell & \mapsto & (\zeta_{m})^{\frac{m}{\ell}}.
\end{array}
\]

It is easily shown that, as an $\F_{p}$-algebra, $A_\ell$ is isomorphic to a product of copies of $\F_{p^\ell}(\zeta_\ell)$,
and $A_m$ to a product of copies of $\F_{p^m}(\zeta_m)$.
This allows to describe all $\F_{p}$-algebra morphisms from $A_\ell$ to $A_m$. However here we will focus only on a certain
subclass of them:
\begin{definition}
\label{Kembedding}
A \emph{Kummer embedding} of $A_\ell$ into $A_m$ is an \emph{injective} $\F_{p}$-algebra morphism $\Phi:A_\ell\hookrightarrow A_m$
such that:
\begin{itemize}
\item $\Phi$ extends the scalar embedding $1\otimes\embedcyc{\ell}{m}$
\item $\Phi$ commutes with $\sigma\otimes1$.
\end{itemize}
\end{definition}

\begin{proposition}
\label{Phialpha}
Let $\alpha_\ell\in A_\ell$ be a nonzero solution of~\eqref{h90} for $\zeta_\ell$, and set $\a_\ell=\a(\alpha_\ell)\in\F_{p}(\zeta_\ell)$.
Then, there is a $1$-to-$1$ correspondence between Kummer embeddings $\Phi:A_\ell\hookrightarrow A_m$ and solutions $\hat{\alpha}\in A_m$
of~\eqref{h90} for $(\zeta_m)^{\frac{m}{\ell}}$ that satisfy $(\hat{\alpha})^\ell=1\otimes\embedcyc{\ell}{m}(\a_\ell)$,
given by \[ \Phi\quad\longleftrightarrow\quad\hat{\alpha}=\Phi(\alpha_\ell). \]
\end{proposition}
\begin{proof}
Direct consequence of Proposition~\ref{alphagen} and Definition~\ref{Kembedding}.
\end{proof}

Actually, Kummer embeddings are easily characterized:
\begin{proposition}
\label{Phipsi}
There is a natural $1$-to-$1$ correspondence between Kummer embeddings $\Phi:A_\ell\hookrightarrow A_m$
and embeddings of finite fields $\psi:\F_{p^\ell}\hookrightarrow\F_{p^m}$, given by:
\begin{itemize}
\item If $\Phi$ is a Kummer embedding, then $\Phi$ maps $\F_{p^\ell}\otimes1$ into $\F_{p^m}\otimes 1$.
Thus the restriction of $\Phi$ to $\F_{p^\ell}\otimes1$ is of the form $\psi\otimes1$ for some $\psi:\F_{p^\ell}\hookrightarrow\F_{p^m}$.
\item Conversely, if $\psi:\F_{p^\ell}\hookrightarrow\F_{p^m}$ is an embedding of finite fields, then $\Phi=\psi\otimes\embedcyc{\ell}{m}$
is a Kummer embedding.
\end{itemize}
Moreover, this correspondence commutes with composition of embeddings.
\end{proposition}
\begin{proof}
Let $\Phi$ be a Kummer embedding. Being a $\F_{p}$-algebra morphism, it satisfies $\Phi(\beta^p)=\Phi(\beta)^p$ for all $\beta\in A_\ell$.
By Lemma~\ref{FrobFrob}, this means that $\Phi$ commutes with $\sigma\otimes\sigma$, and thus,
also with $(\sigma\otimes 1)^{-1}\circ(\sigma\otimes\sigma)=1\otimes\sigma$.
This gives that $\Phi$ maps $\F_{p^\ell}\otimes1$ into $\F_{p^m}\otimes 1$.
The other assertions are clear.
\end{proof}

\begin{corollary}
\label{alphapsi}
Let $\alpha_\ell\in A_\ell$ be a nonzero solution of~\eqref{h90} for $\zeta_\ell$,
and $\hat{\alpha}\in A_m$ a solution of~\eqref{h90} for $(\zeta_m)^{\frac{m}{\ell}}$
that satisfies $(\hat{\alpha})^\ell=1\otimes\embedcyc{\ell}{m}(\a_\ell)$.
Then:
\begin{itemize}
\item $\hat{\alpha}\in\F_{p^m}\otimes\F_{p}((\zeta_m)^{\frac{m}{\ell}})\;\subset\;A_m$
\item the assignation $\first{\alpha_{\ell}}{\zeta_\ell}\mapsto\first{\hat{\alpha}}{(\zeta_m)^{\frac{m}{\ell}}}$
defines an embedding $\psi:\F_{p^\ell}\hookrightarrow\F_{p^m}$
\item $\Phi=\psi\otimes\embedcyc{\ell}{m}$ is the unique Kummer embedding such that $\Phi(\alpha_\ell)=\hat{\alpha}$.
\end{itemize}
\end{corollary}
\begin{proof}
By Proposition~\ref{Phialpha} there is a unique Kummer embedding $\Phi$ such that $\Phi(\alpha_\ell)=\hat{\alpha}$.
By Proposition~\ref{Phipsi} we have $\Phi=\psi\otimes\embedcyc{\ell}{m}$ for some $\psi:\F_{p^\ell}\hookrightarrow\F_{p^m}$.
Writing $\alpha_\ell=\sum_{i=0}^{a-1}x_i\otimes\zeta_{\ell}^i$,
it follows \[ \hat{\alpha}=\Phi(\alpha_\ell)=\sum_{i=0}^{a-1}\psi(x_i)\otimes(\zeta_m)^{\frac{mi}{\ell}}. \]
Thus $\first{\hat{\alpha}}{(\zeta_m)^{\frac{m}{\ell}}}=\psi(x_0)=\psi(\first{\alpha_{\ell}}{\zeta_\ell})$,
and since $\first{\alpha_{\ell}}{\zeta_\ell}$ generates $\F_{p^\ell}$, this uniquely characterizes $\psi$.
\end{proof}

We can now state and prove Allombert's algorithm.

\begin{algorithm_endline}
  {Allombert's}
  {blackbox $\F_{p^\ell}, \F_{p^m}$, with $\ell\,|\,m$ not divisible by $p$.}
  {$s\in\F_{p^\ell}, t\in\F_{p^m}$, such that the assignation $s\mapsto t$
  defines an embedding $\psi:\F_{p^\ell}\hookrightarrow\F_{p^m}$.}
  {algo:allombert}
\item Prepare the Kummer algebras $A_\ell$ and $A_m$.
\item Find $\alpha_\ell\in A_\ell$, $\alpha_m\in A_m$ nonzero solutions of \eqref{h90} for $\zeta_\ell$
  and $\zeta_m$ respectively.
\item Compute $\kappa$ a $\ell$-th root of $\embedcyc{\ell}{m}(\a_\ell)/\a_m$.
\item Return $\first{\alpha_{\ell}}{\zeta_\ell}$ and $\first{(1\otimes\kappa)(\alpha_m)^{\frac{m}{\ell}}}{(\zeta_m)^{\frac{m}{\ell}}}$.
\vspace{.5\baselineskip}
\end{algorithm_endline}

\begin{proposition}
  Algorithm~\ref{algo:allombert} is correct: it returns elements that define an
  embedding $\psi:\F_{p^\ell}\hookrightarrow\F_{p^m}$.
\end{proposition}
\begin{proof}
By Propositions~\ref{Phialpha} and~\ref{Phipsi}, there exists $\hat{\alpha}\in A_m$
solution of~\eqref{h90} for $(\zeta_m)^{\frac{m}{\ell}}$ that satisfy $(\hat{\alpha})^\ell=1\otimes\embedcyc{\ell}{m}(\a_\ell)$.
On the other hand, $(\alpha_m)^{\frac{m}{\ell}}\in A_m$ is also a solution of~\eqref{h90} for $(\zeta_m)^{\frac{m}{\ell}}$,
thus $(\alpha_m)^{\frac{m}{\ell}}=(1\otimes\lambda)(\hat{\alpha})$ for some $\lambda\in\F_{p}(\zeta_m)$.
It follows $\embedcyc{\ell}{m}(\a_\ell)/\a_m=\lambda^{-\ell}$ is a $\ell$-th power,
and $\kappa = (\zeta_{m})^{\frac{um}{\ell}}\lambda^{-1}$ for some integer $u$.
Now we can replace $\hat{\alpha}$
with $(1\otimes(\zeta_{m})^{\frac{um}{\ell}})(\hat{\alpha})=(1\otimes\kappa)(\alpha_m)^{\frac{m}{\ell}}$
and conclude with Corollary~\ref{alphapsi}.
\end{proof}
From this proof and Proposition~\ref{depend}, we remark that another choice of the $l$-th root $\kappa$
only changes $\psi$ by a power of $\sigma$.
    
\section{Standard solutions of (H90)}
\label{sec:compatibleH90}

There are two points in Algorithm~\ref{algo:allombert} on which we would like to improve:
\begin{description}
\item[\emph{Uniqueness:}] As mentioned, the element $\first{\alpha_{\ell}}{\zeta_\ell}$ is a generating element for $\F_{p^{\ell}}$,
or equivalently, it provides a defining irreducible polynomial of degree $\ell$.
However this polynomial depends on the choice of $\alpha_{\ell}$
(even though only through~$\a_\ell$, cf. Proposition~\ref{depend}).
\item[\emph{Compatibility:}] The embedding $\psi$ depends on a constant $\kappa=\kappa_{\ell,m}$,
which itself depends on the choice of $\alpha_\ell,\alpha_m$ (and of a $\ell$-th root extraction).
Thus, given a certain number of finite fields, in order to ensure compatibility of the various
embeddings between them, one has to keep track of all these constants $\kappa$,
which grows \emph{quadratically} with the number of fields.
\end{description}

It would be very nice if one could always force $\kappa=1$, that is, if $\alpha_\ell,\alpha_m$
and $\Phi:A_\ell\hookrightarrow A_m$
could be chosen so that $\Phi(\alpha_\ell)=(\alpha_m)^{\frac{m}{\ell}}$.
\begin{lemma}
\label{power_compatibily}
Let $\alpha_\ell\in A_\ell$, $\alpha_m\in A_m$ be nonzero solutions of \eqref{h90} for $\zeta_\ell$
and $\zeta_m$ respectively. Then, there is a Kummer embedding $\Phi:A_\ell\hookrightarrow A_m$
such that $\Phi(\alpha_\ell)=(\alpha_m)^{\frac{m}{\ell}}$ if and only if $\a_m=\embedcyc{\ell}{m}(\a_\ell)$.

Moreover, if so, then this $\Phi$ is unique.
\end{lemma}
\begin{proof}
Proposition~\ref{Phialpha} with $\hat{\alpha}=(\alpha_m)^{\frac{m}{\ell}}$.
\end{proof}
Observe that if Lemma~\ref{power_compatibily} is satisfied,
necessarily $\a_m$ lies in the subfield $\F_{p}((\zeta_m)^{\frac{m}{\ell}})$ of $\F_{p}(\zeta_m)$.
Possibly this condition could fail if $A_\ell$ and $A_m$ do not have the same field of scalars.
This motivates:
\begin{definition}
\label{complete}
A Kummer algebra is \emph{complete} if it is of the largest degree for a given level.
Thus, the complete Kummer algebra of level $a$ is
\[ A_{p^a-1}=\F_{p^{p^a-1}}\otimes\F_{p}(\zeta_{p^a-1}). \]
\end{definition}
\begin{lemma}
\label{Kummer_bizarre}
For any $\alpha_{p^a-1}\in A_{p^a-1}$ nonzero solution of \eqref{h90} for $\zeta_{p^a-1}$,
we have $\a_{p^a-1}=(\zeta_{p^a-1})^a$.
\end{lemma}
\begin{proof}
From Lemma~\ref{FrobFrob} and the fact that $\sigma^a$ is trivial on $\F_{p}(\zeta_{p^a-1})\simeq\F_{p^a}$ we get
\begin{equation*}
\begin{split}
(\alpha_{p^a-1})^{p^a}=(\sigma^a\otimes\sigma^a)(\alpha_{p^a-1})&=(\sigma^a\otimes1)(\alpha_{p^a-1})\\
&=(1\otimes\zeta_{p^a-1})^a\alpha_{p^a-1}.
\end{split}
\end{equation*}
We conclude since $\alpha_{p^a-1}$ is invertible.
\end{proof}
\begin{definition}
\label{alphastandard}
Let $l$ be an integer not divisible by $p$.
We say a solution $\alpha_\ell\in A_\ell$ of~\eqref{h90} for $\zeta_\ell$ is \emph{standard}
if it satisfies
\[ \a_{\ell}=(\zeta_{p^a-1})^a \]
where $a=\lambda(\ell)$ is the level of $A_\ell$.

By a \emph{decorated} Kummer algebra we mean a pair
\[ (A_\ell,\alpha_{\ell}) \]
with such $\alpha_\ell$ standard.
\end{definition}
For complete algebras, Lemma~\ref{Kummer_bizarre} asserts that all nonzero $\alpha_{p^a-1}$ are standard.
\begin{proposition}
\label{standardexiste}
Let $l$ be an integer not divisible by $p$.
Then $A_\ell$ can be decorated, i.e. it admits a standard $\alpha_\ell$.
Moreover, this $\alpha_\ell$ is unique up to a $\ell$-th root of unity.
\end{proposition}
\begin{proof}
Let $\alpha'_\ell$ be any nonzero solution of~\eqref{h90} for $\zeta_\ell$.
Set $a=\lambda(\ell)$, pick any $\alpha_{p^a-1}\in A_{p^a-1}$ standard (Lemma~\ref{Kummer_bizarre}),
and pick any Kummer embedding $\Phi:A_\ell\hookrightarrow A_{p^a-1}$ (Proposition~\ref{Phipsi}).
Then $\Phi(\alpha'_\ell)$ and $(\alpha_{p^a-1})^{\frac{p^a-1}{\ell}}$ are two nonzero solutions of~\eqref{h90}
for $\zeta_\ell=(\zeta_{p^a-1})^{\frac{p^a-1}{\ell}}$ in $A_{p^a-1}$, thus there is a scalar $\lambda\in\F_{p}(\zeta_\ell)=\F_{p}(\zeta_{p^a-1})$
such that \[(\alpha_{p^a-1})^{\frac{p^a-1}{\ell}}=(1\otimes\lambda)\Phi(\alpha'_\ell).\]
Setting $\alpha_\ell=(1\otimes\lambda\eta)\alpha'_\ell\in A_\ell$ for $\eta\in\F_{p}(\zeta_\ell)$,
we get $\a_\ell=\eta^\ell\a_{p^a-1}$, and
thus the standard $\alpha_\ell\in A_\ell$ are the $(1\otimes\lambda\zeta_\ell^u)\alpha'_\ell$, for $0\leq u<\ell$.
\end{proof}
This allows:
\begin{algorithm_endline}
  {decoration-standardization}
  {blackbox $\F_{p^\ell}$, for $\ell$ an integer not divisible by $p$.}
  {$(A_\ell,\alpha_\ell)$ decorated, $P_\ell$ irreducible polynomial of degree $\ell$,
  and $s\in\F_{p^\ell}$ a generating element inducing $\F_{p^\ell}\simeq\F_{p}[T]/(P_\ell)$.}
  {algo:decoration}
\item Prepare the Kummer algebra $A_\ell$.
\item Find $\alpha'_\ell\in A_\ell$ nonzero solution of \eqref{h90} for $\zeta_\ell$.
\item Compute $\kappa$ a $\ell$-th root of $(\zeta_{p^a-1})^a/\a'_\ell$.
\item Set $\alpha_{\ell}=(1\otimes\kappa)\alpha'_\ell$.
\item Compute $P_\ell$ the minimal polynomial of $\first{\alpha_{\ell}}{\zeta_\ell}$ over $\F_{p}$.
\item Return $(A_\ell,\alpha_\ell)$, $P_\ell$, and $\first{\alpha_\ell}{\zeta_\ell}$.
\vspace{.5\baselineskip}
\end{algorithm_endline}
Algorithm~\ref{algo:decoration} is correct: indeed Proposition~\ref{standardexiste} ensures that
a standard $\alpha_{\ell}$ exists, and thus, $\alpha'_\ell=(1\otimes\kappa^{-1})\alpha_{\ell}$
for some $\kappa\in\F_{p}(\zeta_\ell)$, so $(\zeta_{p^a-1})^a/\a'_\ell=\kappa^\ell$ is a $\ell$-th power.

By Proposition~\ref{depend}, we also note that $P_\ell$ only depends on $\a_{\ell}=(\zeta_{p^a-1})^a$,
and thus it only depends on the chosen primitive polynomial of order $p^a-1$,
e.g. the Conway polynomial of degree $a=\lambda(\ell)$.
In this sense, $P_\ell$ gives a standard definition of $\F_{p^\ell}$.

By design, decorated Kummer algebras of the same level admit standard Kummer embeddings,
under which the corresponding standard solutions of~\eqref{h90} are power-compatible:
\begin{proposition}
\label{embedincomplete}
Let $\ell\,|\,m$ not divisible by $p$ be such $\lambda(\ell)=\lambda(m)=a$.
Let $(A_\ell,\alpha_\ell)$, $(A_m,\alpha_m)$ be decorated Kummer algebras
of degree $\ell,m$ respectively, and of the same level $a$.
Then there is a unique Kummer embedding
\[ \embedalg{l}{m}:A_\ell\hookrightarrow A_m \]
such that $\embedalg{l}{m}(\alpha_\ell)=(\alpha_m)^{\frac{m}{\ell}}$.
\end{proposition}
\begin{proof}
Special case of Lemma~\ref{power_compatibily}.
\end{proof}
Most often we will apply Proposition~\ref{embedincomplete} with $m=p^a-1$.

On the other hand, because of Lemma~\ref{power_compatibily}, a Kummer embedding
between decorated Kummer algebras of different levels cannot have this power-compatibity.
However, at least between complete decorated algebras, we can request some \emph{norm}-compatibility
instead.

Let $a\,|\,b$ be two integers. Observe that the subalgebra of the complete algebra $A_{p^b-1}$ invariant under $1\otimes\sigma^a$ is
\[ (A_{p^b-1})^{1\otimes\sigma^a}=\F_{p^{p^b-1}}\otimes\F_{p}((\zeta_{p^b-1})^{\frac{p^b-1}{p^a-1}}) \]
where $(\zeta_{p^b-1})^{\frac{p^b-1}{p^a-1}}=\operatorname{N}_{\F_{p^b}/\F_{p^a}}(\zeta_{p^b-1})=\embedcyc{a}{b}(\zeta_{p^a-1})$.

\begin{definition}
\label{def:norm}
For integers $a\,|\,b\,|\,c$, we define
\[
\begin{array}{cccc}
  \norm_{b/a}: & (A_{p^c-1})^{1\otimes\sigma^b} & \to & (A_{p^c-1})^{1\otimes\sigma^a} \\
  & \gamma & \mapsto & \prod_{0\leq j<\frac{b}{a}} (1 \otimes \sigma^{ja})(\gamma).
\end{array}
\]
\end{definition}
We view these $\norm_{b/a}$ as ``norms'' on the fields of scalars of the Kummer algebras.
They are well-defined, i.e. the image of $\norm_{b/a}$ is invariant under $1\otimes\sigma^a$ as specified.
They are multiplicative:
\[
  \norm_{b/a}(\gamma\gamma')=\norm_{b/a}(\gamma)\norm_{b/a}(\gamma'),
\]
transitive: \[ \norm_{c/a} = \norm_{b/a}\circ\norm_{c/b},\] and they
commute with $\sigma\otimes1$.
And by construction, $\norm_{b/a}$ acts on $1\otimes\F_{p^b}$ as $1\otimes\operatorname{N}_{\F_{p^b}/\F_{p^a}}$.
\begin{proposition}
\label{embedcomplete}
Let $a\,|\,b$ be integers,
and $(A_{p^a-1},\alpha_{p^a-1})$, $(A_{p^b-1},\alpha_{p^b-1})$ decorated complete Kummer algebras
of level $a,b$ respectively.
Then there is a unique Kummer embedding
\[ \embedalg{p^a-1}{p^b-1}:A_{p^a-1}\hookrightarrow A_{p^b-1} \]
such that $\embedalg{p^a-1}{p^b-1}(\alpha_{p^a-1})=\norm_{b/a}(\alpha_{p^b-1})$.
\end{proposition}
\begin{proof}
Set $\hat\alpha=\norm_{b/a}(\alpha_{p^b-1})$.
Choose an arbitrary Kummer embedding $\Phi:A_{p^a-1}\hookrightarrow A_{p^b-1}$ (Proposition~\ref{Phipsi}),
and set $\hat\alpha'=\Phi(\alpha_{p^a-1})$, so $(\hat\alpha')^{p^a-1}=1\otimes\embedcyc{p^a-1}{p^b-1}(\a_{p^a-1})$.
Then $\hat\alpha,\hat\alpha'\in A_{p^b-1}$ are two nonzero solutions of~\eqref{h90}
for $(\zeta_{p^b-1})^{\frac{p^b-1}{p^a-1}}$, of order $p^a-1$.
Thus $\hat\alpha=(1\otimes\lambda)\hat\alpha'$ for some $\lambda\in\F_{p^b}$,
and \[ (\hat\alpha)^{p^a-1}=1\otimes\lambda^{p^a-1}\embedcyc{p^a-1}{p^b-1}(\a_{p^a-1}). \]
But both $\hat\alpha,\hat\alpha'$ are invariant under $1\otimes\sigma^a$, so $\lambda$ is invariant under $\sigma^a$,
i.e. $\lambda^{p^a-1}=1$.
We conclude with Proposition~\ref{Phialpha}.
\end{proof}



\section{Incrementally constructing lattices}
\label{sec:construction}
In Section~\ref{sec:lattices} we have seen that we can construct a compatible
lattice by computing a solution of~\eqref{h90} in a complete algebra and
by deducting the solutions in all the sub-algebras. The cost of this mode of
operation is too high to use in practice, because the size of the complete
algebras grow exponentially in their level. Instead, we see how we can
increment our lattice in a compatible way.
Essentially, we have to find a way of telling which solutions of~\eqref{h90} are
coming from a solution in a complete algebra. We need a lemma to help us in this task:
\begin{lemma}
  \label{lemma:formula}
  Let $n\in\N$ be an integer, $\zeta_{p^n-1}\in\F_{p^n}$ a
  primitive element in $\F_{p^n}$ (a $(p^n-1)$-th primitive root of
  unity), and
  \[
    A_{p^n-1} = \F_{p^{p^n-1}}\otimes\F_{p^n}.
  \]
  Denote by $\alpha_{p^n-1}\in A_{p^{n}-1}$ a solution of~\eqref{h90} for the
  root $\zeta_{p^n-1}$, then we have that
  \[
    \a_{p^n-1} = (\alpha_{p^n-1})^{p^n-1} = (1\otimes\zeta_{p^n-1})^n.
  \]
\end{lemma}
\begin{proof}
  Since $\alpha_{p^n-1}$ is a solution of~\eqref{h90} for the root
  $\zeta_{p^n-1}$, we have that
  \[
    (\sigma\otimes 1)(\alpha_{p^n-1}) =
    (1\otimes\zeta_{p^n-1})\alpha_{p^n-1}.
  \]
  It follows that
  \begin{align*}
    (1\otimes\zeta_{p^n-1})^n \alpha_{p^n-1} &= (\sigma^n\otimes1)(\alpha_{p^n-1})\\
    &= (\sigma^n\otimes\sigma^n)(\alpha_{p^n-1})\\
    &= (\alpha_{p^n-1})^{p^n}\\
    &= \a_{p^n-1}\cdot\alpha_{p^n-1}.
  \end{align*}
  Therefore, we have the equality
  \[
    ( (1\otimes\zeta_{p^n-1})^n - \a_{p^n-1})\alpha_{p^n-1} = 0,
  \]
  and since $1\otimes\zeta_{p^n-1}$ and $\a_{p^n-1}$ are both elements of the
  subfield $1\otimes\F_{p^n}$, we conclude that
  \[
    \a_{p^n-1} = (1\otimes\zeta_{p^n-1})^n.
  \]
\end{proof}

Lemma~\ref{lemma:formula} gives a necessary condition for solutions of~\eqref{h90}
to be derived from a solution in a complete algebra. We can see that this condition is in fact
also sufficient.
\begin{proposition}
  Let $A_\ell$ a Kummer algebra of level $a$ and $\alpha_\ell\in A_\ell$ for the
  root $\zeta_\ell$. There exists a solution $\alpha_{p^a-1}\in A_{p^a-1}$ for
  the root $\zeta_{p^a-1}$ such that
  \[
    (\alpha_{p^a-1})^{\frac{p^a-1}{\ell}}=\embedalg{\ell}{p^a-1}(\alpha_\ell)
  \]
  if and only if $\a_\ell = (\alpha_{\ell})^{\ell} = (1\otimes\zeta_{p^a-1})^a$.
\end{proposition}
\begin{proof}
 If we have  
  \[
    (\alpha_{p^a-1})^{\frac{p^a-1}{\ell}}=\embedalg{\ell}{p^a-1}(\alpha_\ell)
  \]
  then we obtain $\a_{\ell} = \a_{p^a-1}$ and we have seen in
  Lemma~\ref{lemma:formula} that $\a_{p^a-1}=(\zeta_{p^a-1})^a$. Conversely,
  assume that $c_\ell = (1\otimes\zeta_{p^a-1})^a$. Take any solution
  $\alpha_{p^a-1}'\in A_{p^a-1}$ of~\eqref{h90} for the root $\zeta_{p^a-1}$.
  The elements $\embedalg{\ell}{p^a-1}(\alpha_\ell)$ and
  $(\alpha_{p^a-1}')^{\frac{p^a-1}{\ell}}$ are two solutions in $A_{p^a-1}$
  of~\eqref{h90} for the root $\zeta_{\ell}$, hence there exists
  $\lambda\in\F_{p^a}$ with
  \[
    \embedalg{\ell}{p^a-1}(\alpha_\ell) =
    (1\otimes\lambda)(\alpha_{p^a-1})^{\frac{p^a-1}{\ell}}.
  \]
  Since we have $\a_\ell = \a_{p^a-1}$, it follows that $\lambda^\ell = 1$ and
  so we have $\lambda=\zeta_{\ell}^u$ for some integer $u$. Noting
  \[
    \alpha_{p^a-1} = (1\otimes\zeta_{p^a-1}^u)\alpha_{p^a-1}',
  \]
  we obtain the desired equality.
\end{proof}

Thus, in practice, for some given integer
$\ell\in\N$ and a Kummer algebra $A_\ell$ of level $a$, we consider solutions of the
equation
\begin{equation}
  \tag{H90$^\star$}
  (\sigma\otimes1)(x) = (1\otimes\zeta_\ell)x,\,x^\ell =
  (1\otimes\zeta_{p^a-1})^a
  \label{h90s}
\end{equation}
with $\zeta_\ell=(\zeta_{p^a-1})^{\frac{p^a-1}{\ell}}$.

\section{Poor Artin-Schreier}
\label{sec:A-S}



\section{Implementation}
\label{sec:implementation}

\bibliographystyle{plain}
\bibliography{gf-h90}

\end{document}

% LocalWords:  embeddings computable Frobenius Lenstra
