\documentclass{sig-alternate}

\usepackage{hyperref}
\usepackage{macros}

\newtheorem{definition}{Definition}
\newtheorem{theorem}{Theorem}
\newtheorem{proposition}{Proposition}
\newtheorem{lemma}{Lemma}

\numberofauthors{3}
\author{
  \alignauthor Luca De Feo\\
  \affaddr{Universit\'e Paris Saclay -- UVSQ, LMV}\\
  \email{luca.de-feo@uvsq.fr}
  \alignauthor Hugues Randriam
  \alignauthor \'Edouard Rousseau
}

\title{Efficient lattices of compatibly embedded finite fields}

\begin{document}

\maketitle

\begin{abstract}
  Lattices of compatibly embedded finite fields are useful in computer
  algebra systems for managing many extensions of a finite field
  $\F_p$ at once. %
  They can also be used to represent the algebraic closure $\bar\F_p$,
  and to represent all finite fields in a standard manner.

  The most well known constructions are Conway polynomials, and the
  Bosma-Cannon-Steel framework used in Magma. %
  They all have drawbacks: Conway polynomials are extremely expensive
  to compute, while the Bosma-Cannon-Steel framework does not provide
  a standard way to represent finite fields, and becomes inefficient
  as the number of extensions grows.

  In this work, leveraging the theory of the Lenstra-Allombert
  isomorphism algorithm, we generalize at the same time Conway
  polynomials and the Bosma-Cannon-Steel framework, obtaining the
  first construction with quadratic complexity in the extension
  degree, and linear complexity in the number of extensions. %
  We also provide an implementation in C/Flint/Julia/Nemo, showing
  that our construction is practical.
\end{abstract}

\category{F.2.1}{Theory of computation}{Analysis of algorithms and problem complexity}[Computations in finite fields]
\category{G.4}{Mathematics of computing}{Mathematical software}
\terms{Algorithms,Theory}
\keywords{Finite fields, field extensions, Conway polynomials.}

\section{Introduction}
\label{sec:introduction}

Computer algebra systems (CAS) are often faced with the problem of
constructing several extensions of a finite field $\F_p$ in a
\emph{compatible} way, i.e., such that the (subfield) inclusion
lattice of the given extensions can be computed and evaluated
efficiently.

Concretely, what is sought is a data structure $\Lambda$ to represent
arbitrary collections of extensions of $\F_p$, in such a way that
elements of $\F_{p^n}$ are represented in optimal space (i.e., $O(n)$
coefficients), and that arithmetic operations are performed
efficiently (i.e., $O\left(\lcm(n,m)^d\right)$ arithmetic operations
to combine an element of $\F_{p^m}$ and an element of $\F_{p^n}$,
where $d\le 3$ and, possibly, $d=1+\varepsilon$). %
To this end, it is useful to set several sub-goals:

\begin{description}
\item[\emph{Effective embeddings:}] For any pair of extensions
  $k\subset K$ in $\Lambda$, there exists an efficiently computable
  embedding $\phi:k\to K$, and algorithms to evaluate $\phi$ on $k$,
  and the section $\phi^{-1}$ on $K$.
\item[\emph{Compatibility:}] The embeddings are \emph{compatible},
  i.e., for any triple $k\subset K\subset L$ in $\Lambda$, and
  embeddings $\phi:k\to K$, $\psi:K\to L$, $\chi:k\to L$, one has
  $\chi=\psi\circ\phi$.
\item[\emph{Incrementality:}] The data associated with an extension
  (e.g., its irreducible polynomial, change-of-basis matrices, \dots)
  must be computable efficiently and \emph{incrementally}, i.e.,
  adding a new field extensions to $\Lambda$ does not require
  recomputing data for all extensions already in $\Lambda$. %
\item[\emph{Uniqueness:}] Any extension of $\F_p$ is determined by an
  irreducible polynomial whose definition only depends on the
  characteristic $p$ and the degree of the extension. %
\item[\emph{Generality:}] Extensions of $\F_p$ can be represented by
  arbitrary irreducible polynomials.
\end{description}

Some goals, such as incrementality, uniqueness and generality are
optional, and it is obvious that uniqueness and generality are even in
conflict with each other. %
An incremental data structure can be used to effectively represent an
algebraic closure $\bar\F_p$, with new finite extensions built on the
fly as they are needed. %
Uniqueness is useful for defining field elements in a standard way,
portable between different CAS, while generality is useful in a
context where the user is left with the freedom of choosing the
defining polynomials. %
Note that any solution can be made unique by replacing all random
choices with pseudo-random ones, however one is usually interested in
uniqueness solutions that have a simple mathematical description. %
Also, any solution can be made general by means of an isomorphism
algorithm~\cite{LenstraJr91,Allombert02,rains2008,brieulle2018computing,narayanan2016fast}. %
Other optional goals, such as computing normal bases or evaluating
Frobenius morphisms, may be added to the list, however they are out of
the scope of this work.

\paragraph{Previous work}
The first and most well known solution is the family of Conway
polynomials~\cite{Nickel1988,heath+loehr99}, first adopted in
GAP~\cite{GAP4}, and then also by Magma~\cite{MAGMA} and
Sage~\cite{Sage}. %
Conway polynomials yield uniqueness, however computing them requires
exponential time, thus incrementality is only available at a
prohibitive cost; for this reason, they are usually pre-computed and
tabulated up to some bound.

The first to show the existence of a (incremental, general) data
structure computable in deterministic polynomial time was
Lenstra~\cite{LenstraJr91}, who proved that, besides the problem of
finding irreducible polynomials, any other question is amenable to
linear algebra. %
Subsequent work of Lenstra and de
Smit~\cite{lenstra+desmit08-stdmodels} tackled the uniqueness problem,
albeit only from a theoretical point of view. %

In practice, randomized algorithms are good enough for a CAS, then
polynomial factorization and basic linear algebra provide an easy
(incremental, general) solution, that was first analyzed by Bosma,
Cannon and Steel~\cite{bosma+cannon+steel97}, and is currently used in
Magma. %

All solutions presented so far have superquadratic complexity, i.e.,
$d>2$. %
Recent work on embedding algorithms~\cite{DoSc12,DeDoSc13,DeDoSc2014}
yields subquadratic (more precisely, $d\le 1.5$) solutions for
specially constructed (non-unique, non-general) families of
irreducible polynomials, and even quasi-optimal ones (i.e.,
$d=1+\varepsilon$) if a quasi-linear modular composition algorithm is
available (Kedlaya and Umans' algorithm~\cite{KeUm11} is quasi-optimal
in the binary RAM model, however it is widely considered
unpractical). %
However these constructions involve counting points of random elliptic
curves over finite fields, and have thus a rather high polynomial
dependency in $\log p$; for this reason, they are usually considered
practical only for relatively small characteristic.


\paragraph{Our contribution}
In this work we present the first
quadratic, % TODO: let's hope this is true...
incremental, general and/or unique % TODO: also this...
solution for lattices of compatibly embedded finite fields. %
Our starting point is Allombert's~\cite{Allombert02} and
subsequent~\cite{brieulle2018computing} improvements to Lenstra's
isomorphism algorithm. %
Plugging them in the Bosma-Cannon-Steel framework immediately produces
a quadratic, incremental general solution, however we go much
further. %
Indeed, we show that the compatibility requirement can be taken a step
further by constructing a lattice of $\F_p$-algebras with a
distinguished element, which is a byproduct of the Lenstra-Allombert
algorithm.

The advantages of our construction over a naive combination of the
Lenstra-Allombert algorithm and the Bosma-Cannon-Steel framework are
multiple. %
Storage drops from quadratic to linear in the number of extensions
stored in $\Lambda$, and the cost of adding a new extension to
$\Lambda$ drops similarly. %
This yields a significant speedup in practice, as we show in our
implementation (see Section~\ref{sec:implementation}).

Our $\F_p$-algebras are constructed by tensoring element-wise an
arbitrary lattice of extensions of $\F_p$ with a lattice of compatible
roots of unity. %
One of the possible ways to construct the second lattice is by using
Conway polynomials; this way, our construction can be seen as a
generalization of Conway polynomials, permitting to represent
(uniquely) an exponentially larger set of finite fields than with
Conway polynomials alone. %
Since the storage overhead for the second lattice is only logarithmic
in the degree of the extension fields, the high cost for computing
Conway polynomials is absorbed in the total complexity.

The main drawback of our method is that, in some instances, combining
elements of $\F_{p^m}$ and $\F_{p^n}$ requires constructing a field
extension of degree larger than $\lcm(m,n)$. %
While this does not affect the asymptotic complexity of our
construction, % TODO: doesn't it?
it can in practice make some computations visibly slower.


\paragraph{Organisation}
The presentation is structured as follows. %
In Section~\ref{sec:conway} we review some basic facts on roots of
unity and Conway polynomials. %
In Section~\ref{sec:lenstra} we review the Lenstra-Allombert algorithm
and define \emph{Kummer
  algebras}, % TODO: Kummer algebras? Does this sound right?
the main ingredient to our construction. %
In Section~\ref{sec:lattices} we prove the existence of lattices of
compatible Kummer algebras, while in Section~\ref{sec:construction} we
explain how to construct them incrementally. %
Finally, in Section~\ref{sec:implementation} we present our
implementation and compare it to available alternatives.


\section{Compatible roots of unity and Conway polynomials}
\label{sec:conway}

% TODO: copy-pasted from Luca's HDR without editing. Clean and shorten
% this.

One of the most famous constructions is that of \emph{Conway
  polynomials}. %
The main feature of Conway polynomials is \emph{norm compatibility}:
the norm map $\F_{q^n}\to\F_{q^m}$ is a surjection from the roots of the
$n$-th Conway polynomial to the roots of the $m$-th Conway polynomial,
whenever $m$ divides $n$. %

Norm compatibility is easy to achieve for a fixed collection
$\mathcal{F}$ of finite extensions of $\F_p$: let $K/\F_p$ be the
smallest finite field containing all fields in $\mathcal{F}$, let
$\eta$ be a primitive element of $K$, i.e., a generator of the
multiplicative group $K^\times$, then the Conway polynomial of a field
$k\subset K$ is defined as the minimal polynomial of $N_{K/k}(\eta)$,
where $N_{K/k}$ is the norm map. %
However, Conway polynomials have two other goals: incrementality and
uniqueness. %
This leads to the following definition.

\begin{definition}[Conway polynomial]
  Let $p$ be a prime and $n>1$ an integer. %
  The \emph{Conway polynomial} $C_{p,n}$ is the
  \emph{lexicographically smallest} monic irreducible polynomial of
  degree $n$ satisfying the following conditions:
  \begin{itemize}
  \item \emph{Primitivity:} $C_{p,n}$ is primitive (i.e., its roots
    generate the multiplicative group $\F_{p^n}^\times$);
  \item \emph{Norm compatibility:} If $m$ divides $n$, then
    $C_{p,m}\left(X^{\frac{p^n-1}{p^m-1}}\right) = 0 \mod C_{p,n}$.
  \end{itemize}
\end{definition}

The ``lexicographically smallest'' condition is required to ensure
uniqueness; it is typically defined by writing $f\in\F_p[X]$ as
\begin{equation*}
  f = \sum_{i=0}^n (-1)^{n-i} f_i x^i,
  \qquad\text{with $0\le f_i<p$,}
\end{equation*}
and taking the lexicographic order on the words $f_n\dots f_0$.

Conway polynomials were defined by Parker%
\footnote{According to LÃ¼beck~\cite{Luebeck}.}, %
who named them in honor of John Conway and his famous book ``On
Numbers and Games''~\cite{Conway:ONAG2000}; their existence was shown
by Nickel~\cite{Nickel1988}. %
They were first adopted by the computer algebra system GAP~\cite{GAP4}
as a default representation for finite fields. %
They are typically computed by exhaustive search over all irreducible
polynomials, or by a slightly better algorithm due to Heath and
Loehr~\cite{heath+loehr99}. %
Given the huge computational cost involved in finding them, they are
usually precomputed; tables of Conway polynomials are available in any
major computer algebra system.%
\footnote{Most computer algebra systems switch to other methods when
  precomputed Conway polynomials are not available. %
  An interesting exception is SageMath (since version
  5.13~\cite{Roe2013}), that defines \emph{pseudo-Conway polynomials}
  by dropping the ``lexicographically first'' requirement, and
  computes them on the fly whenever a true Conway polynomial is not
  available in the tables. %
  The approach is notoriously slow: computing a pseudo-Conway
  polynomial for $\F_{p^{30}}$ takes in the order of seconds, already
  for $p>1000$; compare this to the milliseconds needed to compute a
  random irreducible polynomial of the same degree.} %

We note that Conway polynomials are not especially good to represent
embeddings: given an element of $\F_{p^m}$ represented as
$a(X) \bmod C_{p,m}(X)$, its image in $\F_{p^n}$, for $m\mid n$, is
computed as $a(X^{(p^n-1)/(p^m-1)})\bmod C_{p,n}(X)$, requiring very
large modular exponentiations; while there are algorithms to perform
this computation in $O(n^{1+o(1)})$ operations~\cite{KeUm11}, they are
known to be very inefficient in practice. %


\section{The Lenstra-Allombert embedding algorithm}
\label{sec:lenstra}
\cite{LenstraJr91}\cite{brieulle2018computing}

%TODO: add context? Change the notation to get rid of \Phi and \phi ?

The main ingredient of Allombert's algorithm~\cite{Allombert02} is an extension
of Kummer theory. Since $\mathbb{F}_{p^\ell}$ is not necessarily a Kummer
extension of $\mathbb{F}_p$, we make an extension of scalars and work in the
\emph{Kummer algebra}
\[
  A_\ell = \mathbb{F}_{p^\ell}\otimes\mathbb{F}_{p}(\zeta_\ell),
\]
where $\zeta_\ell$ is a primitive $\ell$-th root of unity. Using, for instance,
Conway polynomials, we assume that the right tower is compatibly embedded: if
$\ell, m$ are two integers such that $\ell\,|\,m$, we have the embedding
\[
\begin{array}{cccc}
  \embedcyc{\ell}{m}: & \mathbb{F}_{p}(\zeta_\ell) & \to & \mathbb{F}_{p}(\zeta_m) \\
  & \zeta_\ell & \mapsto & (\zeta_{m})^{m/\ell}.
\end{array}
\]
Denoting by $\sigma$ the Frobenius automorphism, Allombert proves that
$\sigma\otimes1$ is again an automorphism of the
$\mathbb{F}_{p}(\zeta_\ell)$-algebra $A_\ell$. The equation
\begin{equation}
  \tag{H90}
 (\sigma\otimes1)(x) = (1\otimes\zeta_\ell)x
  \label{h90}
\end{equation}
then plays the role of $\sigma(x)=\zeta_\ell x$ in the classical theory. The
solutions of~\eqref{h90} in $A_\ell$ form a dimension $1$
$\mathbb{F}_{p}(\zeta_{\ell})$-vector space and if $\alpha_\ell$ is a
nonzero solution
of~\eqref{h90}, we define $\a_\ell = (\alpha_\ell)^\ell$ and remark that
$\a_\ell$ is a nonzero element in $1\otimes\mathbb{F}_{p}(\zeta_\ell)$. Finally,
if $r$ is the dimension of the extension
$\mathbb{F}_{p}(\zeta_\ell)/\mathbb{F}_p$, and if we write
\[
  \alpha_\ell = \sum_{i =  0}^{r-1}a_i\otimes\zeta_{\ell}^i,
\]
the element $a_0$ is known to be a primitive element of the extension
$\mathbb{F}_{p^\ell}/\mathbb{F}_{p}$. This element plays a central role and we
denote it by $a_0 = \first{\alpha_\ell}{\zeta_\ell}$. Put together, these facts give Allombert's
algorithm.

\begin{algorithm_endline}
  {Allombert's}
  {$\mathbb{F}_{p^\ell}, \mathbb{F}_{p^m}$, with $\ell\,|\,m$.}
  {$s\in\mathbb{F}_{p^\ell}, t\in\mathbb{F}_{p^m}$, such that the map $s\mapsto t$
  defines an embedding $\embed{\ell}{m}$.}
  {algo:allombert}
\item Compute the Kummer algebras $A_\ell$ and $A_m$.
\item Find a solution $\alpha_\ell\in A_\ell$ of~\eqref{h90} for $\zeta_\ell$
  and a solution $\alpha_m\in A_m$ of~\eqref{h90} for $\zeta_m$.
\item Compute $s$ a $\ell$-th root of $\embedcyc{\ell}{m}(\a_\ell)/\a_m$.
\item Return $\first{\alpha_{\ell}}{\zeta_\ell}$ and $\first{s\times
    (\alpha_m)^{m/\ell}}{(\zeta_m)^{m/\ell}}$
\end{algorithm_endline}

\begin{proposition}
  Algorithm~\ref{algo:allombert} is correct: it returns elements that define an
  embedding $\embed{\ell}{m}$.
\end{proposition}
\begin{proof}
  Let $\embedalg{\ell}{m}'=\embed{\ell}{m}'\otimes\embedcyc{\ell}{m}$ an embedding
  between the algebras $A_\ell$ and $A_m$, where $\embed{\ell}{m}'$ is some
  arbitrary embedding between $\mathbb{F}_{p^\ell}$ and $\mathbb{F}_{p^m}$.
  Since $\sigma\otimes1$ and $\embedalg{\ell}{m}$ commute,
  $\embedalg{\ell}{m}(\alpha_\ell)$ are $(\alpha_m)^{(m/\ell)}$ are two solutions
  in $A_m$ of~\eqref{h90} for the root $(\zeta_m)^{m/\ell} =
  \embedcyc{\ell}{m}(\zeta_\ell)$. The solutions form a vector space of
  dimension $1$, so we know there exists $\lambda\in\mathbb{F}_{p}(\zeta_m)$
  with
  \[
    (\alpha_m)^{m/\ell} = (1\otimes\lambda)\embedalg{\ell}{m}(\alpha_\ell).
  \]
  We can then compute a $\ell$-th root $s = 1\otimes(\zeta_{m})^{um/\ell}\lambda^{-1}$, for some
  integer $u$, thus we obtain
  \begin{align*}
    s\times(\alpha_m)^{m/\ell} &= \embedalg{\ell}{m}'(\zeta_\ell^u\alpha_\ell)\\
    &= \embedalg{\ell}{m}(\alpha_\ell),
  \end{align*}
  with $\embedalg{\ell}{m}=\embed{\ell}{m}\otimes\embedcyc{\ell}{m}$ and
  $\embed{\ell}{m} = \embed{\ell}{m}'\circ\sigma^u$. It follows that
  $\embed{\ell}{m}(x_0)=y_0$, and since $x_0$ is a primitive element of
  $\mathbb{F}_{p^\ell}/\mathbb{F}_{p}$, this relation is sufficient to define
  $\embed{\ell}{m}$.
\end{proof}

\section{Norm-compatible lattices of Kummer algebras}
\label{sec:lattices}

In order to prove the existence of a compatible lattice of finite fields,
we construct a slightly more rigid structure: a norm-compatible lattice of
Kummer algebras. For $a, b$ two integers with $a\,|\,b$, and $A$ a Kummer
algebra, we define
\[
\begin{array}{cccc}
  \N_{b/a}: & A & \to & A \\
  & \gamma & \mapsto & \prod_{j=0}^{b/a-1} (1 \otimes
  \sigma^{ja})(\gamma).
\end{array}
\]
The ``norms'' $\N$ are transitive: given $a, b, c$ three integers with
$a\,|\,b\,|\,c$, we have $\N_{c/a} = \N_{b/a}\circ\N_{c/b}$. These maps also
commute with $\sigma\otimes1$, that will also be important for the construction
of our structure.

\begin{proposition}
  There exists a family of solutions of \eqref{h90}
  $(\alpha_{p^n-1})_{n\in\mathbb{N}}$, corresponding to the roots of unity
  $(\zeta_{p^n-1})_{n\in\mathbb{N}}$, such that, for each $a,b\in\mathbb{N}$
  with $a\,|\,b$, we have
  \[
    \N_{b/a}(\alpha_{p^b-1})=\alpha_{p^a-1}.
  \]
\end{proposition}
\begin{proof}

%TODO: make the proof shorter? Cleaner? Better?
  % Instead of doing the calculation, I can just say that we can find an element
  % alpha using the surjectivity of the norm and the fact the solutions are a
  % dimension 1 vector space

  We prove the result by induction. First, choose any primitive element
  $\zeta_{p-1}\in\mathbb{F}_p$, and a solution $\alpha_{p-1}\in
  A_{p-1}$ of \eqref{h90} for the root $\zeta_{p-1}$. Then, suppose that we have
  a family of solutions of \eqref{h90} $(\alpha_{p^n-1})_{n\in \left[ d
  \right]}$ for the roots
  $(\zeta_{p^n-1})_{n\in \left[ d \right]}$, where $\left[ d \right]$ is
  the set of all the divisors of some integer $d\in\mathbb{N}$, and such that for all $a,
  b\in \left[ d \right]$ with $a\,|\,b$, we have
  \[
    \N_{b/a}(\alpha_{p^b-1})=\alpha_{p^a-1}.
  \]
  Let $e\in\mathbb{N}$ such that $d\,|\,e$, consider the
  finite field extension $\mathbb{F}_{p^{e}}/\mathbb{F}_{p^{d}}$, and
  let $N:\mathbb{F}_{p^{e}}\to\mathbb{F}_{p^{d}}$ be the corresponding
  norm. Since $N$ is surjective, we note $y\in\mathbb{F}_{p^{e}}$ such
  that
  \[
    N(y) = \zeta_{p^{d}-1}.
  \]
  Because $N(y)=y^{\frac{p^{e}-1}{p^{d}-1}}$, we have that the order of
  $y$ is $p^{e}-1$, otherwise the order of $N(y)=\zeta_{p^{d}-1}$ could not
  be $p^{d_n}-1$. Hence we can define a new root $\zeta_{p^{e}-1}=y$, and we
  have that
  \[
    N(\zeta_{p^{e}-1})=\zeta_{p^{d}-1}.
  \]
  Furthermore, the map $\N_{e/d}$ acts on
  $1\otimes\mathbb{F}_{p^{e}}$ exactly as $1\otimes N$, so we also have
  \[
    \N_{e/d}(1\otimes\zeta_{p^{e}-1}) = 1\otimes\zeta_{p^{d}-1}.
  \]
Now let
$\beta\in A_{p^{e}-1}$ be any nonzero solution of \eqref{h90} with the root
$\zeta_{p^{e}-1}$.
Then we get
\begin{align*}
  (\sigma\otimes1)(\N_{e/d}(\beta)) &= \N_{e/d}((\sigma\otimes1)(\beta)) \\
  &= \N_{e/d}(1\otimes\zeta_{p^{e}-1}) \N_{e/d}(\beta) \\
  &= (1\otimes\zeta_{p^{d}-1})\N_{e/d}(\beta),
\end{align*}
meaning that we have
\[
  \N_{e/d}(\beta)=(1\otimes\lambda)\alpha_{p^{d}-1},
\]
where $\lambda\in\mathbb{F}_{p^d}$. Since the map
$\N_{e/d}$ acts on $1\otimes\mathbb{F}_{p^{e}}$ as the
usual norm $N$, we can use
the surjectivity of the norm to ``correct'' our element $\beta$. In the end we
obtain an element $\alpha_{p^{e}-1}$ such
that
\[
  \N_{e/d}(\alpha_{p^{e}-1}) = \alpha_{p^{d}-1}.
\]
Since our norm-like functions $\N$ are transitive, we also obtain that
\[
  \N_{b/a}(\alpha_{p^b-1})=\alpha_{p^a-1}
\]
for any $a,b\in \left[ d \right]\cup\left\{ e \right\}$ such that
$a\,|\,b$. Additionnaly, for every divisor $c$ of $e$ that is not already in $\left[
d \right]$, we define
\[
  \alpha_{p^c-1}=\N_{e/c}(\alpha_{p^{e}-1}).
\]
In the end, for any $a, b\in\left[ e \right]$ such that
$a\,|\,b$ we have that
\[
  \N_{b/a}(\alpha_{p^b-1})=\alpha_{p^a-1}.
\]
The result follows by considering any sequence $(d_n)_{n\in\mathbb{N}}$ such
that for all $n\in\mathbb{N}$, $d_n\,|\,d_{n+1}$ and for all
$\ell\in\mathbb{N}$, there exists $n_\ell\in\mathbb{N}$ with
$\ell\,|\,d_{n_\ell}$.
\end{proof}


\section{Incrementally constructing lattices}
\label{sec:construction}

\subsection{Poor Artin-Schreier}


\section{Implementation}
\label{sec:implementation}

\bibliographystyle{plain}
\bibliography{gf-h90}

\end{document}

% LocalWords:  embeddings computable Frobenius Lenstra
